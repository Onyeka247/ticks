<html lang="en" style="touch-action: pan-y;"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Customize Your Tickets</title>
    <style>
        /* Prevent zooming and ensure fixed layout */
        html, body {
            touch-action: manipulation;
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
            margin: 0;
        }
        input, select, textarea {
            font-size: 16px; /* Prevents iOS zoom on focus */
        }
        body {
            background-color: #f5f5f5;
            color: #333;
            font-size: 16px;
            position: relative;
            padding-bottom: 70px; /* Space for bottom nav */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        .container {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 90px; /* Extra padding for bottom nav */
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            /* Adjust for status bar */
            padding-top: calc(15px + env(safe-area-inset-top));
        }
        .page-title {
            font-size: 18px;
            font-weight: bold;
            margin-right: 100px;
        }
        .back-button {
            color: #1a52ed;
            font-weight: bold;
            cursor: pointer;
        }
        .clear-placeholder-container {
            text-align: right;
            max-width: 200px;
        }
        .clear-placeholder-btn {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .clear-placeholder-desc {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #1a52ed;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        input[type="file"] {
            padding: 8px;
        }
        
        input[type="color"] {
            height: 40px;
        }
        
        .countdown-inputs {
            display: flex;
            gap: 10px;
        }
        
        .countdown-inputs input {
            flex: 1;
        }
        
        .preview-image {
            width: 100%;
            height: 150px;
            background-size: cover;
            background-position: center;
            margin-top: 10px;
            border-radius: 5px;
        }
        
        .button {
            background-color: #1a52ed;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        .button:hover {
            background-color: #1545cc;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            border-top: 1px solid #e0e0e0;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #999;
            text-decoration: none;
            padding: 8px 12px;
            transition: color 0.2s ease;
        }

        .nav-item.active {
            color: #024ddf;
        }

        .nav-item:hover {
            color: #024ddf;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            object-fit: contain;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 500;
        }
        
        .success-message {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
        }
        
        /* Live preview styles */
        .preview-section {
            background-color: #f5f5f5;
            color: #0d44d6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .preview-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .ticket-preview {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .ticket-header {
            background-color: #1a52ed;
            color: white;
            padding: 20px 15px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ticket-type-label {
            font-size: 20px;
            font-weight: bold;
        }

        .seat-info-container {
            display: flex;
            justify-content: space-around;
            margin-top: 5px;
        }

        .seat-column {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .seat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .seat-value {
            font-size: 18px;
            font-weight: bold;
        }

        /* For General Admission layout */
        .general-admission-layout {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .general-admission-text {
            font-size: 18px;
            font-weight: bold;
        }
        
        .ticket-section-info {
            display: flex;
            padding: 15px;
            color: #333;
        }
        
        .section-label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .ticket-type {
            flex-grow: 1;
            text-align: right;
            font-weight: bold;
        }
        
        .ticket-image-preview {
            width: 100%;
            height: 120px;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .ticket-image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 15px;
        }
        
        .event-title-preview {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .event-details-preview {
            font-size: 12px;
        }
        
        .countdown-preview {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            color: #333;
        }
        
        .countdown-unit {
            text-align: center;
        }
        
        .countdown-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .countdown-label {
            font-size: 10px;
            color: #666;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 40% auto;
            padding: 25px;
            width: 80%;
            max-width: 350px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #1a52ed;
        }

        .modal-message {
            margin-bottom: 25px;
            font-size: 16px;
            line-height: 1.4;
        }

        .modal-button {
            background-color: #1a52ed;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .modal-button:hover {
            background-color: #0d44d6;
        }

        html {
  touch-action: manipulation;
  overflow-y: auto !important;
  position: relative !important;
  -webkit-overflow-scrolling: touch;
}

body {
  overscroll-behavior-y: contain;
  min-height: 100vh;
}

/* Modal Styles */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    justify-content: center;
    align-items: center;
}

.modal-overlay.show {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.success-modal {
    text-align: center;
    max-width: 350px;
}

.success-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    animation: successBounce 0.6s ease-out;
}

@keyframes successBounce {
    0% {
        transform: scale(0.3);
        opacity: 0;
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

.success-modal h3 {
    color: #28a745;
    margin-bottom: 15px;
    font-size: 1.5rem;
}

.success-modal p {
    color: #666;
    margin-bottom: 25px;
    font-size: 1rem;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary {
    background: #0066cc;
    color: white;
}

.btn-primary:hover {
    background: #0052a3;
}
    </style>
</head>
<body>
    <div class="header" style="display: flex; align-items: center; justify-content: space-between;">
        <div class="back-button" onclick="window.location.href='index.html'">Back</div>
        <div class="page-title" style="flex: 1; text-align: center; font-size: 18px; font-weight: bold; margin: 0;">Customize Tickets</div>
        <button id="resetAppBtn" style="background:#ff4d4d;color:white;border:none;padding:8px 12px;border-radius:5px;font-weight:bold;cursor:pointer;">Reset App</button>
    </div>
    
    <div class="container" style="overflow-y: auto; height: calc(100% - 50px);">
        <div class="success-message" id="successMessage">
            Settings saved successfully! Your tickets have been updated.
        </div>
        
        <div class="preview-section">
            <div class="preview-title">Live Preview</div>
            <div class="ticket-preview">
                <div class="ticket-header">
                    <div class="ticket-type-label" id="previewTicketType">American ExpressÂ® Presale</div>
                    <div class="seat-info-container" id="seatInfoContainer">
                    <div class="general-admission-layout">
                        <div class="seat-column">
                            <div class="seat-label">SECTION</div>
                            <div class="seat-value">...</div>
                        </div>
                        <div class="general-admission-text">GENERAL ADMISSION</div>
                    </div>
                </div>
                </div>
                <div class="ticket-image-preview" id="previewBanner" style="background-image: url('https://source.unsplash.com/random/800x600/?concert')">
                    <div class="ticket-image-overlay">
                        <div class="event-title-preview" id="previewEventTitle">Ticket Name</div>
                        <div class="event-details-preview" id="previewEventDetails">Sat, Nov 22, 7:00 PM â€¢ Chase Center</div>
                    </div>
                </div>
                <div class="countdown-preview">
                    <div class="countdown-unit">
                        <div class="countdown-value" id="previewDays">179</div>
                        <div class="countdown-label">DAYS</div>
                    </div>
                    <div class="countdown-unit">
                        <div class="countdown-value" id="previewHours">08</div>
                        <div class="countdown-label">HOURS</div>
                    </div>
                    <div class="countdown-unit">
                        <div class="countdown-value" id="previewMinutes">36</div>
                        <div class="countdown-label">MINS</div>
                    </div>
                    <div class="countdown-unit">
                        <div class="countdown-value" id="previewSeconds">11</div>
                        <div class="countdown-label">SECS</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section" style="display: block;">
            <div class="section-title">Event Details</div>
            
            <div class="form-group">
                <label for="eventTitle">Event Title</label>
                <input type="text" id="eventTitle" placeholder="e.g., Ticket Name">
            </div>
            
            <div class="form-group">
                <label for="eventDate">Event Date &amp; Time</label>
                <input type="text" id="eventDate" placeholder="e.g., Sat, Nov 22, 7:00 PM">
            </div>
            
            <div class="form-group">
                <label for="eventVenue">Venue</label>
                <input type="text" id="eventVenue" placeholder="e.g., Chase Center">
            </div>
            
            <div class="form-group">
                <label for="ticketType">Ticket Type</label>
                <select id="ticketType">
                    <option value="American ExpressÂ® Presale">American ExpressÂ® Presale</option>
                    <option value="Verified Fan Presale">Verified Fan Presale</option>
                    <option value="General Sale">General Sale</option>
                    <option value="VIP Package">VIP Package</option>
                    <option value="Custom">Custom</option>
                </select>
            </div>
            <div class="form-group" id="customTicketTypeGroup" style="display:none;">
                <label for="customTicketType">Custom Ticket Type</label>
                <input type="text" id="customTicketType" placeholder="Enter your custom ticket type">
            </div>
        </div>
        
        <!-- NEW: Camping Ticket Date Section -->
        <div class="section" id="campingDateSection" style="display: block;">
            <div class="section-title">Camping Ticket Dates</div>
            <div style="background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
                <small style="color: #1976d2; font-weight: 500;">
                    ðŸ’¡ <strong>Use this for:</strong> Multi-day camping events, festivals, weekend passes, or any event spanning multiple days. 
                    This will create dates like "Fri, 29 Aug - Sun, 31 Aug 2025" for your tickets.
                </small>
            </div>
            <div class="form-group">
                <label for="isCampingEvent">Is this a camping event?</label>
                <select id="isCampingEvent" onchange="toggleCampingDateFields()">
                    <option value="false">No - Single day event</option>
                    <option value="true">Yes - Multi-day camping event</option>
                </select>
            </div>
            
            <div id="campingDateFields" style="display: none;">
                <div class="form-group">
                    <label for="campingStartDate">Camping Start Date</label>
                    <input type="date" id="campingStartDate">
                </div>
                
                <div class="form-group">
                    <label for="campingEndDate">Camping End Date</label>
                    <input type="date" id="campingEndDate">
                </div>
                
                <div class="form-group">
                    <label for="campingDatePreview">Camping Date Preview</label>
                    <div id="campingDatePreview" style="padding: 15px; background-color: rgb(245, 245, 245); border-radius: 8px; font-weight: bold; color: rgb(102, 102, 102); text-align: center; border: 2px solid rgb(224, 224, 224); transition: 0.3s;">Select start and end dates to see preview</div>
                    <button type="button" onclick="testCampingDatePreview()" style="margin-top: 10px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Test Preview</button>
                </div>
                
                <div class="form-group">
                    <label for="campingDateFormat">Date Format</label>
                    <select id="campingDateFormat">
                        <option value="short">Short (Fri, 29 Aug - Sun, 31 Aug 2025)</option>
                        <option value="long">Long (Friday, August 29 - Sunday, August 31, 2025)</option>
                        <option value="custom">Custom Format</option>
                    </select>
                </div>
                
                <div class="form-group" id="customDateFormatGroup" style="display: none;">
                    <label for="customDateFormat">Custom Date Format</label>
                    <input type="text" id="customDateFormat" placeholder="e.g., Fri, 29 Aug - Sun, 31 Aug 2025">
                    <small style="color: #666; font-size: 12px;">Use placeholders: {startDay}, {startMonth}, {startDate}, {endDay}, {endMonth}, {endDate}, {year}</small>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Seat Information</div>
            
            <div class="form-group">
                <label for="section">Section</label>
                <input type="text" id="section" placeholder="e.g., ...">
            </div>
            
            <div class="form-group">
                <label for="seatType">Seat Type</label>
                <select id="seatType">
                    <option value="General Admission">General Admission</option>
                    <option value="Reserved Seating">Reserved Seating</option>
                    <option value="VIP Seating">VIP Seating</option>
                    <option value="Floor Seating">Floor Seating</option>
                    <option value="Balcony">Balcony</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="entryLevel">Entry Level Seat Label</label>
                <input type="text" id="entryLevel" placeholder="e.g., Mobile Entry, Entry Level Seat, Lower Section">
            </div>
            
            <div class="form-group seat-details" id="seatDetailsGroup" style="display: none;">
                <label for="row">Row</label>
                <input type="text" id="row" placeholder="e.g., 22">
            </div>
            
            <div class="form-group seat-details" id="seatNumberGroup" style="display: none;">
                <label for="seat">Seat</label>
                <input type="text" id="seat" placeholder="e.g., 24">
            </div>
            
            <div class="form-group">
                <label for="ticketCount">Number of Tickets</label>
                <input type="number" id="ticketCount" min="1" max="10" value="3">
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Countdown Timer</div>
            
            <div class="form-group">
                <label for="countdownTarget">Set Target Date and Time</label>
                <input type="datetime-local" id="countdownTarget">
            </div>
            
            <div class="form-group">
                <label>Or set time remaining manually:</label>
                <div class="countdown-inputs">
                    <input type="number" id="countdownDays" placeholder="Days" min="0" value="179">
                    <input type="number" id="countdownHours" placeholder="Hours" min="0" max="23" value="8">
                    <input type="number" id="countdownMinutes" placeholder="Minutes" min="0" max="59" value="36">
                    <input type="number" id="countdownSeconds" placeholder="Seconds" min="0" max="59" value="11">
                </div>
            </div>
            <div class="form-group">
                <label for="showCountdownToggle">Show Countdown Timer for This Event</label>
                <input type="checkbox" id="showCountdownToggle">
            </div>
        </div>

    <script>
        // Initialize the toggle state from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.getElementById('showCountdownToggle');
            if (!toggle) return;

            // Check if editing an event and load individual preference
            const editingEventId = localStorage.getItem('editingEventId');
            if (editingEventId) {
                const events = JSON.parse(localStorage.getItem('events') || '[]');
                const editingEvent = events.find(event => String(event.id) === editingEventId);
                if (editingEvent && editingEvent.showCountdown !== undefined) {
                    // Load the individual event's countdown preference
                    toggle.checked = editingEvent.showCountdown;
                } else {
                    // Default to true for new events
                    toggle.checked = true;
                }
            } else {
                // No editing event, default to true
                toggle.checked = true;
            }

            // Save preference on change (this will be saved with the event data)
            toggle.addEventListener('change', function() {
                // The preference will be saved when the event is saved
                console.log('Countdown preference changed:', this.checked);
            });
        });
        
        // NEW: Camping Date Functions
        function toggleCampingDateFields() {
            const isCampingEvent = document.getElementById('isCampingEvent').value === 'true';
            const campingDateFields = document.getElementById('campingDateFields');
            const campingDateSection = document.getElementById('campingDateSection');
            const eventDetailsSection = document.getElementById('eventDate').closest('.section');
            
            if (isCampingEvent) {
                campingDateFields.style.display = 'block';
                campingDateSection.style.display = 'block';
                // Hide the entire Event Details section when camping is selected
                if (eventDetailsSection) {
                    eventDetailsSection.style.display = 'none';
                }
                
                // NEW: Auto-populate camping dates if they're empty
                autoPopulateCampingDates();
                
                // NEW: Clear regular event date to avoid confusion
                const regularEventDate = document.getElementById('eventDate');
                if (regularEventDate) {
                    regularEventDate.value = '';
                }
                
                // CRITICAL FIX: Update the event date field with the camping date preview
                // This ensures the date is visible in the UI and gets saved correctly
                setTimeout(() => {
                    updateCampingDatePreview();
                }, 100);
            } else {
                campingDateFields.style.display = 'none';
                campingDateSection.style.display = 'block'; // Keep section visible for option
                // Show the entire Event Details section when camping is not selected
                if (eventDetailsSection) {
                    eventDetailsSection.style.display = 'block';
                }
                
                // Reset camping date preview styling
                resetCampingDatePreview();
                
                // NEW: Restore regular event date if it was previously set
                restoreRegularEventDate();
            }
        }
        
        // NEW: Function to reset camping date preview styling
        function resetCampingDatePreview() {
            const preview = document.getElementById('campingDatePreview');
            if (preview) {
                preview.textContent = 'Select start and end dates to see preview';
                preview.style.color = '#666';
                preview.style.backgroundColor = '#f5f5f5';
                preview.style.borderColor = '#e0e0e0';
            }
        }
        
        // NEW: Function to auto-populate camping dates with sensible defaults
        function autoPopulateCampingDates() {
            const startDateInput = document.getElementById('campingStartDate');
            const endDateInput = document.getElementById('campingEndDate');
            
            if (startDateInput && endDateInput) {
                // Only populate if dates are empty
                if (!startDateInput.value || !endDateInput.value) {
                    const today = new Date();
                    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                    const nextWeekend = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000);
                    
                    // Set start date to next weekend (Friday)
                    const friday = new Date(nextWeekend);
                    friday.setDate(friday.getDate() + (5 - friday.getDay() + 7) % 7);
                    startDateInput.value = friday.toISOString().split('T')[0];
                    
                    // Set end date to Sunday (3 days later)
                    const sunday = new Date(friday);
                    sunday.setDate(friday.getDate() + 2);
                    endDateInput.value = sunday.toISOString().split('T')[0];
                    
                    // Update preview
                    updateCampingDatePreview();
                }
            }
        }
        
        // NEW: Function to restore regular event date when camping is deselected
        function restoreRegularEventDate() {
            const regularEventDate = document.getElementById('eventDate');
            if (regularEventDate && !regularEventDate.value) {
                // Restore default event date if none is set
                regularEventDate.value = 'Sat, Nov 22, 7:00 PM';
                
                // Update preview
                updateEventDetailsPreview();
            }
        }
        
        // NEW: Function to load preferred camping date format preferences
        function loadPreferredCampingDatePreferences() {
            const preferredFormat = localStorage.getItem('preferredCampingDateFormat');
            const preferredCustomFormat = localStorage.getItem('preferredCustomDateFormat');
            
            if (preferredFormat) {
                const campingDateFormat = document.getElementById('campingDateFormat');
                if (campingDateFormat) {
                    campingDateFormat.value = preferredFormat;
                    
                    // If custom format is preferred, also load the custom format text
                    if (preferredFormat === 'custom' && preferredCustomFormat) {
                        const customDateFormat = document.getElementById('customDateFormat');
                        if (customDateFormat) {
                            customDateFormat.value = preferredCustomFormat;
                        }
                    }
                }
            }
        }
        
        // NEW: Test function to debug camping date preview
        function testCampingDatePreview() {
            console.log('=== TESTING CAMPING DATE PREVIEW ===');
            
            const startDate = document.getElementById('campingStartDate').value;
            const endDate = document.getElementById('campingEndDate').value;
            const format = document.getElementById('campingDateFormat').value;
            
            console.log('Raw input values:', { startDate, endDate, format });
            
            if (!startDate || !endDate) {
                console.log('Missing dates');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            console.log('Parsed dates:', { 
                start, 
                end, 
                startValid: !isNaN(start), 
                endValid: !isNaN(end),
                startString: start.toString(),
                endString: end.toString()
            });
            
            if (isNaN(start) || isNaN(end)) {
                console.log('Invalid dates parsed');
                return;
            }
            
            console.log('Date comparison:', start > end ? 'Start > End (INVALID)' : 'Start <= End (VALID)');
            
            // Test the format function directly
            if (format === 'short') {
                const result = formatShortCampingDate(start, end);
                console.log('Short format result:', result);
            }
        }
        
        // NEW: Debug function to check camping date elements
        function debugCampingDateElements() {
            console.log('Debugging camping date elements...');
            const elements = {
                isCampingEvent: document.getElementById('isCampingEvent'),
                campingStartDate: document.getElementById('campingStartDate'),
                campingEndDate: document.getElementById('campingEndDate'),
                campingDateFormat: document.getElementById('campingDateFormat'),
                customDateFormat: document.getElementById('customDateFormat'),
                campingDatePreview: document.getElementById('campingDatePreview'),
                eventDate: document.getElementById('eventDate'),
                eventDetailsSection: document.getElementById('eventDate')?.closest('.section')
            };
            
            console.log('Camping date elements found:', elements);
            
            // Check if camping is selected
            const isCamping = elements.isCampingEvent?.value === 'true';
            console.log('Is camping event selected:', isCamping);
            
            // Check camping date values
            if (isCamping) {
                console.log('Camping start date:', elements.campingStartDate?.value);
                console.log('Camping end date:', elements.campingEndDate?.value);
                console.log('Camping date format:', elements.campingDateFormat?.value);
            }
        }
        
        function updateCampingDatePreview() {
            const startDate = document.getElementById('campingStartDate').value;
            const endDate = document.getElementById('campingEndDate').value;
            const format = document.getElementById('campingDateFormat').value;
            const preview = document.getElementById('campingDatePreview');
            
            console.log('Camping date inputs:', { startDate, endDate, format });
            
            if (!startDate || !endDate) {
                preview.textContent = 'Select start and end dates to see preview';
                preview.style.color = '#666';
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            console.log('Parsed dates:', { start, end, startValid: !isNaN(start), endValid: !isNaN(end) });
            
            if (start > end) {
                preview.textContent = 'Start date must be before end date';
                preview.style.color = '#d32f2f';
                return;
            }
            
            // Check if dates are in the past
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (start < today) {
                preview.textContent = 'Start date cannot be in the past';
                preview.style.color = '#d32f2f';
                return;
            }
            
            let formattedDate = '';
            
            console.log('=== CAMPING DATE FORMATTING DEBUG ===');
            console.log('Selected format:', format);
            console.log('Start date:', start);
            console.log('End date:', end);
            
            if (format === 'short') {
                formattedDate = formatShortCampingDate(start, end);
                console.log('Using SHORT format function');
            } else if (format === 'long') {
                formattedDate = formatLongCampingDate(start, end);
                console.log('Using LONG format function');
            } else if (format === 'custom') {
                formattedDate = formatCustomCampingDate(start, end);
                console.log('Using CUSTOM format function');
            } else {
                console.log('Unknown format, defaulting to short');
                formattedDate = formatShortCampingDate(start, end);
            }
            
            console.log('Final formatted camping date:', formattedDate);
            console.log('================================');
            
            preview.textContent = formattedDate;
            preview.style.color = '#333';
            
            // CRITICAL FIX: Update the event date field with the camping date
            document.getElementById('eventDate').value = formattedDate;
            
            // CRITICAL FIX: Save both the formatted display date AND a parseable date for my-events
            // The formatted date is for display, the parseable date is for sorting/categorization
            // FIXED: Don't use toISOString() as it converts to UTC and causes timezone shift
            // Create a date string in local timezone: "2025-09-04"
            const parseableDate = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}-${String(start.getDate()).padStart(2, '0')}`;
            localStorage.setItem('campingParseableDate', parseableDate);
            console.log('=== CAMPING DATE DEBUG ===');
            console.log('Formatted display date:', formattedDate);
            console.log('Parseable ISO date:', parseableDate);
            console.log('Start date object:', start);
            console.log('End date object:', end);
            console.log('========================');
            
            // Update the preview display
            updateEventDetailsPreview();
        }
        
        // NEW: Helper function to update countdown inputs from target date
        function updateCountdownFromTargetDate(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            
            if (diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                // Update countdown input fields
                const daysInput = document.getElementById('countdownDays');
                const hoursInput = document.getElementById('countdownHours');
                const minutesInput = document.getElementById('countdownMinutes');
                const secondsInput = document.getElementById('countdownSeconds');
                
                if (daysInput) daysInput.value = days;
                if (hoursInput) hoursInput.value = hours;
                if (minutesInput) minutesInput.value = minutes;
                if (secondsInput) secondsInput.value = seconds;
                
                // Update preview countdown
                const previewDays = document.getElementById('previewDays');
                const previewHours = document.getElementById('previewHours');
                const previewMinutes = document.getElementById('previewMinutes');
                const previewSeconds = document.getElementById('previewSeconds');
                
                if (previewDays) previewDays.textContent = String(days).padStart(2, '0');
                if (previewHours) previewHours.textContent = String(hours).padStart(2, '0');
                if (previewMinutes) previewMinutes.textContent = String(minutes).padStart(2, '0');
                if (previewSeconds) previewSeconds.textContent = String(seconds).padStart(2, '0');
            }
        }
        
        function formatShortCampingDate(start, end) {
            const startDay = start.toLocaleDateString('en-US', { weekday: 'short' });
            const startDate = start.getDate();
            const startMonth = start.toLocaleDateString('en-US', { month: 'short' });
            const endDay = end.toLocaleDateString('en-US', { weekday: 'short' });
            const endDate = end.getDate();
            const endMonth = end.toLocaleDateString('en-US', { month: 'short' });
            const year = start.getFullYear();
            
            // If same month, show: Fri, 29 Aug - Sun, 31 Aug 2025
            if (start.getMonth() === end.getMonth()) {
                return `${startDay}, ${startDate} ${startMonth} - ${endDay}, ${endDate} ${endMonth} ${year}`;
            } else {
                // Different months: Fri, 29 Aug - Sun, 31 Sep 2025
                return `${startDay}, ${startDate} ${startMonth} - ${endDay}, ${endDate} ${endMonth} ${year}`;
            }
        }
        
        function formatLongCampingDate(start, end) {
            const startDay = start.toLocaleDateString('en-US', { weekday: 'long' });
            const startDate = start.getDate();
            const startMonth = start.toLocaleDateString('en-US', { month: 'long' });
            const endDay = end.toLocaleDateString('en-US', { weekday: 'long' });
            const endDate = end.getDate();
            const endMonth = end.toLocaleDateString('en-US', { month: 'long' });
            const year = start.getFullYear();
            
            if (start.getMonth() === end.getMonth()) {
                return `${startDay}, ${startMonth} ${startDate} - ${endDay}, ${endMonth} ${endDate}, ${year}`;
            } else {
                return `${startDay}, ${startMonth} ${startDate} - ${endDay}, ${endMonth} ${endDate}, ${year}`;
            }
        }
        
        function formatCustomCampingDate(start, end) {
            const customFormat = document.getElementById('customDateFormat').value;
            if (!customFormat) return formatShortCampingDate(start, end);
            
            const startDay = start.toLocaleDateString('en-US', { weekday: 'short' });
            const startDate = start.getDate();
            const startMonth = start.toLocaleDateString('en-US', { month: 'short' });
            const endDay = end.toLocaleDateString('en-US', { weekday: 'short' });
            const endDate = end.getDate();
            const endMonth = end.toLocaleDateString('en-US', { month: 'short' });
            const year = start.getFullYear();
            
            return customFormat
                .replace(/{startDay}/g, startDay)
                .replace(/{startDate}/g, startDate)
                .replace(/{startMonth}/g, startMonth)
                .replace(/{endDay}/g, endDay)
                .replace(/{endDate}/g, endDate)
                .replace(/{endMonth}/g, endMonth)
                .replace(/{year}/g, year);
        }
        
        function handleCustomDateFormatChange() {
            const format = document.getElementById('campingDateFormat').value;
            const customGroup = document.getElementById('customDateFormatGroup');
            
            if (format === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
            
            updateCampingDatePreview();
        }
        
        function initializeCampingDateFunctionality() {
            console.log('Initializing camping date functionality...');
            
            // Add event listeners for camping date fields
            const campingStartDate = document.getElementById('campingStartDate');
            const campingEndDate = document.getElementById('campingEndDate');
            const campingDateFormat = document.getElementById('campingDateFormat');
            const isCampingEvent = document.getElementById('isCampingEvent');
            
            if (campingStartDate && campingEndDate && campingDateFormat && isCampingEvent) {
                // Event listeners for date changes
                campingStartDate.addEventListener('change', function() {
                    console.log('Camping start date changed:', this.value);
                    updateCampingDatePreview();
                });
                campingEndDate.addEventListener('change', function() {
                    console.log('Camping end date changed:', this.value);
                    updateCampingDatePreview();
                });
                campingDateFormat.addEventListener('change', function() {
                    console.log('=== CAMPING DATE FORMAT CHANGE DEBUG ===');
                    console.log('New format selected:', this.value);
                    console.log('Current camping start date:', campingStartDate.value);
                    console.log('Current camping end date:', campingEndDate.value);
                    
                    handleCustomDateFormatChange();
                    
                    // Force update the preview with new format
                    setTimeout(() => {
                        console.log('Forcing camping date preview update after format change...');
                        updateCampingDatePreview();
                        
                        // Also update the event date field
                        const eventDateField = document.getElementById('eventDate');
                        const campingPreview = document.getElementById('campingDatePreview');
                        if (eventDateField && campingPreview && campingPreview.textContent !== 'Select start and end dates to see preview') {
                            eventDateField.value = campingPreview.textContent;
                            console.log('Event date field updated after format change:', eventDateField.value);
                        }
                    }, 100);
                });
                
                // Load saved camping date settings
                loadCampingDateSettings();
                
                // Set default dates if none are set
                if (!campingStartDate.value) {
                    const today = new Date();
                    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                    campingStartDate.value = today.toISOString().split('T')[0];
                    campingEndDate.value = nextWeek.toISOString().split('T')[0];
                }
                
                // NEW: Load preferred camping date format preferences
                loadPreferredCampingDatePreferences();
                
                // Initialize the custom date format group visibility
                handleCustomDateFormatChange();
                
                // Debug camping date elements
                debugCampingDateElements();
                
                console.log('Camping date functionality initialized successfully');
            } else {
                console.error('Some camping date elements not found');
                debugCampingDateElements();
            }
        }
        
        function loadCampingDateSettings() {
            // Check if editing an existing event
            const editingEventId = localStorage.getItem('editingEventId');
            if (editingEventId) {
                const events = JSON.parse(localStorage.getItem('events') || '[]');
                const editingEvent = events.find(event => String(event.id) === editingEventId);
                
                if (editingEvent && editingEvent.isCampingEvent) {
                    // Load camping event settings
                    document.getElementById('isCampingEvent').value = 'true';
                    toggleCampingDateFields();
                    
                    if (editingEvent.campingStartDate) {
                        document.getElementById('campingStartDate').value = editingEvent.campingStartDate;
                    }
                    if (editingEvent.campingEndDate) {
                        document.getElementById('campingEndDate').value = editingEvent.campingEndDate;
                    }
                    if (editingEvent.campingDateFormat) {
                        document.getElementById('campingDateFormat').value = editingEvent.campingDateFormat;
                        console.log('Loaded camping date format:', editingEvent.campingDateFormat);
                    }
                    if (editingEvent.customDateFormat) {
                        document.getElementById('customDateFormat').value = editingEvent.customDateFormat;
                        console.log('Loaded custom date format:', editingEvent.customDateFormat);
                    }
                    
                    console.log('=== LOADING CAMPING EVENT DEBUG ===');
                    console.log('Camping start date loaded:', editingEvent.campingStartDate);
                    console.log('Camping end date loaded:', editingEvent.campingEndDate);
                    console.log('Camping date format loaded:', editingEvent.campingDateFormat);
                    console.log('Custom date format loaded:', editingEvent.customDateFormat);
                    console.log('================================');
                    
                    // Update preview
                    updateCampingDatePreview();
                    
                    // CRITICAL FIX: Ensure the event date field is updated with camping date
                    // This fixes the issue where camping dates weren't showing in the UI
                    setTimeout(() => {
                        console.log('Forcing camping date preview update after loading...');
                        updateCampingDatePreview();
                        
                        // Also update the event date field
                        const eventDateField = document.getElementById('eventDate');
                        const campingPreview = document.getElementById('campingDatePreview');
                        if (eventDateField && campingPreview && campingPreview.textContent !== 'Select start and end dates to see preview') {
                            eventDateField.value = campingPreview.textContent;
                            console.log('Event date field updated after loading:', eventDateField.value);
                        }
                    }, 200);
                } else {
                    // Not a camping event, ensure camping fields are hidden
                    document.getElementById('isCampingEvent').value = 'false';
                    toggleCampingDateFields();
                }
            } else {
                // No editing event, ensure camping fields are hidden by default
                document.getElementById('isCampingEvent').value = 'false';
                toggleCampingDateFields();
            }
            
            // Force the toggle to ensure proper display state
            setTimeout(() => {
                toggleCampingDateFields();
            }, 50);
        }
    </script>
        
        <div class="section">
            <div class="section-title">Event Banner</div>
            
            <div class="form-group">
                <label for="bannerImage">Upload Custom Banner Image</label>
                <p class="banner-size-note" style="font-size: 12px; color: #666; margin-top: 5px;">
                    Recommended size: 800Ã—450 pixels. Max file size: 2MB.
                </p>
                <input type="file" id="bannerImage" accept="image/*">
            </div>
            
            <div class="preview-image" id="bannerPreview"></div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label for="useDefaultBanner">Or use a default image</label>
                <select id="useDefaultBanner">
                    <option value="">Select a default image</option>
                    <option value="https://images.unsplash.com/photo-1501281668745-f7f57925c3b4?ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=800&amp;h=450&amp;q=80">Concert</option>
                    <option value="https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=800&amp;h=450&amp;q=80">Festival</option>
                    <option value="https://images.unsplash.com/photo-1540039155733-5bb30b53aa14?ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=800&amp;h=450&amp;q=80">Stadium</option>
                    <option value="https://images.unsplash.com/photo-1514525253161-7a46d19cd819?ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=800&amp;h=450&amp;q=80">Concert Stage</option>
                </select>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Venue Information</div>
            
            <div class="form-group">
                <label for="venueName">Venue Name</label>
                <input type="text" id="venueName" placeholder="e.g., Chase Center">
            </div>
            
            <div class="form-group">
                <label for="venueLocation">Venue Location</label>
                <input type="text" id="venueLocation" placeholder="e.g., San Francisco, CA">
            </div>
            
            <div class="form-group">
                <label for="venueImage">Venue Map/Seating Chart (Optional)</label>
                <input type="file" id="venueImage" accept="image/*">
                <div id="venueImagePreview" class="image-preview"></div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Map Settings</div>
            
            <div class="form-group">
                <label for="mapLocation">Map Location</label>
                <input type="text" id="mapLocation" placeholder="e.g., Chase Center, San Francisco CA">
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Add-ons</div>
            
            <div class="form-group">
                <label for="vipEarlyEntryOption">VIP Early Entry ($25.00)</label>
                <select id="vipEarlyEntryOption">
                    <option value="false">Not Included</option>
                    <option value="true">Include</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="merchPackageOption">Merchandise Package ($45.00)</label>
                <select id="merchPackageOption">
                    <option value="false">Not Included</option>
                    <option value="true">Include</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="premiumParkingOption">Premium Parking ($30.00)</label>
                <select id="premiumParkingOption">
                    <option value="false">Not Included</option>
                    <option value="true">Include</option>
                </select>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Pricing Information</div>
            
            <div class="form-group">
                <label for="ticketPrice">Ticket Price ($)</label>
                <input type="number" id="ticketPrice" min="0" step="0.01" value="89.50">
            </div>
            
            <div class="form-group">
                <label for="serviceFee">Service Fee ($)</label>
                <input type="number" id="serviceFee" min="0" step="0.01" value="15.75">
            </div>
            
            <div class="form-group">
                <label for="facilityCharge">Facility Charge ($)</label>
                <input type="number" id="facilityCharge" min="0" step="0.01" value="5.00">
            </div>
            
            <div class="form-group">
                <label for="processingFee">Order Processing Fee ($)</label>
                <input type="number" id="processingFee" min="0" step="0.01" value="5.50">
            </div>

            <div class="form-group">
                <label for="paymentDate">Payment Date</label>
                <input type="date" id="paymentDate" value="">
            </div>
        </div>
        
        <button class="button" id="saveButton" onclick="saveChanges()">Save Changes</button>
        <button class="button" style="background-color: #0052cc; margin-top: 10px;" onclick="window.location.href='my-events.html'">View My Events</button>
        <button class="button" style="background-color: #666; margin-top: 10px;" onclick="window.location.href='index.html'">Back to Tickets</button>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="home.html" class="nav-item" data-grey-icon="public/assets/discover_grey.png" data-blue-icon="public/assets/discover_blue.png">
            <img src="public/assets/discover_grey.png" alt="Discover" class="nav-icon">
            <span class="nav-label">Discover</span>
        </a>
        <a href="for-you.html" class="nav-item active" data-grey-icon="public/assets/for_you_grey.png" data-blue-icon="public/assets/heart.png">
            <img src="public/assets/heart.png" alt="For You" class="nav-icon">
            <span class="nav-label">For You</span>
        </a>
        <a href="my-events.html" class="nav-item" data-grey-icon="public/assets/grey_event.png" data-blue-icon="public/assets/events.png">
            <img src="public/assets/grey_event.png" alt="My Tickets" class="nav-icon">
            <span class="nav-label">My Tickets</span>
        </a>
        <a href="sell.html" class="nav-item" data-grey-icon="public/assets/sell_grey.png" data-blue-icon="public/assets/sell_blue.png">
            <img src="public/assets/sell_grey.png" alt="Sell" class="nav-icon">
            <span class="nav-label">Sell</span>
        </a>
        <a href="account.html" class="nav-item" data-grey-icon="public/assets/account_grey.png" data-blue-icon="public/assets/account-blue.png">
            <img src="public/assets/account_grey.png" alt="My Account" class="nav-icon">
            <span class="nav-label">My Account</span>
        </a>
    </nav>

    <script>
        // Navigation functionality
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                // Only prevent default for the current page (for-you.html)
                if (this.href.includes('for-you.html')) {
                    e.preventDefault();
                }
                
                // Remove active class from all nav items and switch to grey icons
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                    const img = nav.querySelector('.nav-icon');
                    const greyIcon = nav.getAttribute('data-grey-icon');
                    if (img && greyIcon) {
                        img.src = greyIcon;
                    }
                });
                
                // Add active class to clicked item and switch to blue icon
                this.classList.add('active');
                const img = this.querySelector('.nav-icon');
                const blueIcon = this.getAttribute('data-blue-icon');
                if (img && blueIcon) {
                    img.src = blueIcon;
                }
            });
        });

        // Helper function to parse event date string (copied from my-events.html)
        function parseEventDate(dateStr) {
            if (!dateStr) return null;
            console.log("Parsing date string:", dateStr);
            
            try {
                if (dateStr.includes('T') && dateStr.includes('Z')) {
                    return new Date(dateStr);
                }
                
                const parts = dateStr.split(',');
                if (parts.length >= 3) {
                    const monthDay = parts[1].trim().split(' ');
                    const month = monthDay[0];
                    const day = parseInt(monthDay[1]);
                    
                    let year;
                    let timeStr;
                    
                    if (parts.length >= 4 && /^\d{4}$/.test(parts[2].trim())) {
                        year = parseInt(parts[2].trim());
                        timeStr = parts[3].trim();
                    } else {
                        year = new Date().getFullYear();
                        timeStr = parts[2].trim();
                    }
                    
                    const months = { 'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5, 'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11 };
                    const monthNum = months[month];
                    
                    const eventDate = new Date(year, monthNum, day);
                    
                    // If the parsed date is in the past, assume it's for the next year
                    if (eventDate < new Date() && new Date().getMonth() > eventDate.getMonth()) {
                        eventDate.setFullYear(year + 1);
                    }
                    return eventDate;
                }
                return new Date(dateStr);
            } catch (e) {
                return null;
            }
        }
        // Global variable for the countdown interval
        let previewCountdownInterval = null;
        
        function loadTicketmasterEventData() {
            try {
                console.log('=== LOADING TICKETMASTER DATA ===');
                console.log('Current URL:', window.location.href);
                console.log('Current domain:', window.location.hostname);
                console.log('localStorage available:', typeof(Storage) !== "undefined");
                
                const ticketmasterData = localStorage.getItem('ticketmasterEventData');
                console.log('Raw ticketmaster data from localStorage:', ticketmasterData);
                
                // Check if data exists and is valid
                if (ticketmasterData && ticketmasterData !== 'null' && ticketmasterData !== 'undefined') {
                    try {
                        const eventData = JSON.parse(ticketmasterData);
                        console.log('Parsed Ticketmaster event data:', eventData);
                        
                        // Add a small delay to ensure DOM elements are ready
                        setTimeout(() => {
                            console.log('Loading Ticketmaster data after delay...');
                            console.log('DOM ready state:', document.readyState);
                    
                    // Pre-fill form fields with Ticketmaster data
                    const eventTitleInput = document.getElementById('eventTitle');
                    const eventDateInput = document.getElementById('eventDate');
                    const eventVenueInput = document.getElementById('eventVenue');
                    const ticketPriceInput = document.getElementById('ticketPrice');
                    
                    console.log('Form elements found:', {
                        eventTitle: !!eventTitleInput,
                        eventDate: !!eventDateInput,
                        eventVenue: !!eventVenueInput,
                        ticketPrice: !!ticketPriceInput
                    });
                    
                    // Additional debugging
                    console.log('All form elements:', {
                        eventTitleElement: eventTitleInput,
                        eventDateElement: eventDateInput,
                        eventVenueElement: eventVenueInput,
                        ticketPriceElement: ticketPriceInput
                    });
                    
                    if (eventTitleInput) {
                        eventTitleInput.value = eventData.title || '';
                        console.log('Set event title:', eventData.title);
                    }
                    
                    if (eventDateInput) {
                        // Use the countdown target date to set the event date if available
                        if (eventData.countdownTargetDate) {
                            const targetDate = new Date(eventData.countdownTargetDate);
                            const formattedEventDate = formatEventDate(targetDate);
                            eventDateInput.value = formattedEventDate;
                            console.log('Set event date from countdown target:', formattedEventDate);
                        } else {
                            eventDateInput.value = eventData.date || '';
                            console.log('Set event date from data:', eventData.date);
                        }
                    }
                    
                    if (eventVenueInput) {
                        eventVenueInput.value = eventData.venue || '';
                        console.log('Set event venue:', eventData.venue);
                    }
                    
                    // Also set the venue name field if it exists
                    const venueNameInput = document.getElementById('venueName');
                    if (venueNameInput) {
                        venueNameInput.value = eventData.venue || '';
                        console.log('Set venue name:', eventData.venue);
                    }
                    
                    if (ticketPriceInput) {
                        // Handle non-numeric price values like "TBD"
                        const priceValue = eventData.ticketPrice || '';
                        if (priceValue === 'TBD' || priceValue === 'Price TBD') {
                            ticketPriceInput.value = '';
                            ticketPriceInput.placeholder = 'TBD';
                        } else {
                            ticketPriceInput.value = priceValue;
                        }
                        console.log('Set ticket price:', eventData.ticketPrice);
                    }
                    
                    // Set banner image if available
                    if (eventData.bannerImage) {
                        console.log('Setting banner image:', eventData.bannerImage);
                        
                        // Update banner preview directly with URL
                        const bannerPreview = document.getElementById('bannerPreview');
                        if (bannerPreview) {
                            bannerPreview.src = eventData.bannerImage;
                            bannerPreview.style.display = 'block';
                            console.log('Banner preview updated');
                        }
                        
                        // Also update the preview banner
                        const previewBanner = document.getElementById('previewBanner');
                        if (previewBanner) {
                            previewBanner.style.backgroundImage = `url('${eventData.bannerImage}')`;
                            console.log('Preview banner updated');
                        }
                        
                        // Store the image URL for saving
                        localStorage.setItem('bannerImageData', eventData.bannerImage);
                        localStorage.setItem('bannerImage', eventData.bannerImage);
                    }
                    
                    // Clear any existing countdown data first to prevent conflicts
                    localStorage.removeItem('countdownTargetDate');
                    localStorage.removeItem('countdownDays');
                    localStorage.removeItem('countdownHours');
                    localStorage.removeItem('countdownMinutes');
                    localStorage.removeItem('countdownSeconds');
                    
                    // Set countdown target date (regardless of countdown toggle state)
                    if (eventData.countdownTargetDate) {
                        console.log('=== SETTING COUNTDOWN TARGET DATE ===');
                        console.log('Event countdownTargetDate:', eventData.countdownTargetDate);
                        
                        const countdownTarget = document.getElementById('countdownTarget');
                        console.log('countdownTarget element found:', !!countdownTarget);
                        
                        if (countdownTarget) {
                            // Convert ISO string to local date format for input
                            const targetDate = new Date(eventData.countdownTargetDate);
                            const localDateString = targetDate.toISOString().slice(0, 16);
                            
                            console.log('Target date:', targetDate);
                            console.log('Local date string:', localDateString);
                            
                            countdownTarget.value = localDateString;
                            
                            // Also save to localStorage so the save function picks it up
                            localStorage.setItem('countdownTargetDate', eventData.countdownTargetDate);
                            
                            // Trigger change event to update any dependent displays
                            countdownTarget.dispatchEvent(new Event('change'));
                            countdownTarget.dispatchEvent(new Event('input'));
                            
                            console.log('âœ… Set target date:', localDateString);
                            console.log('Field value after setting:', countdownTarget.value);
                        } else {
                            console.error('âŒ countdownTarget element not found!');
                        }
                    } else {
                        console.log('No countdownTargetDate in event data');
                    }
                    
                    // Fallback: Try to set countdown target again after a short delay
                    setTimeout(() => {
                        if (eventData.countdownTargetDate) {
                            const countdownTarget = document.getElementById('countdownTarget');
                            if (countdownTarget && !countdownTarget.value) {
                                console.log('ðŸ”„ Fallback: Setting countdown target after delay');
                                const targetDate = new Date(eventData.countdownTargetDate);
                                const localDateString = targetDate.toISOString().slice(0, 16);
                                countdownTarget.value = localDateString;
                                countdownTarget.dispatchEvent(new Event('change'));
                                console.log('âœ… Fallback set target date:', localDateString);
                            }
                        }
                    }, 500);
                    
                    // Set countdown timer toggle if enabled
                    if (eventData.showCountdown && eventData.countdownTargetDate) {
                        const countdownToggle = document.getElementById('countdownToggle');
                        
                        if (countdownToggle) {
                            countdownToggle.checked = true;
                            // Trigger the change event to show countdown fields
                            countdownToggle.dispatchEvent(new Event('change'));
                        }
                        
                        // Also populate the individual countdown fields if they exist
                        if (eventData.countdownDays !== undefined) {
                            const countdownDays = document.getElementById('countdownDays');
                            const countdownHours = document.getElementById('countdownHours');
                            const countdownMinutes = document.getElementById('countdownMinutes');
                            const countdownSeconds = document.getElementById('countdownSeconds');
                            
                            if (countdownDays) countdownDays.value = eventData.countdownDays || 0;
                            if (countdownHours) countdownHours.value = eventData.countdownHours || 0;
                            if (countdownMinutes) countdownMinutes.value = eventData.countdownMinutes || 0;
                            if (countdownSeconds) countdownSeconds.value = eventData.countdownSeconds || 0;
                            
                            // Also save to localStorage so the save function picks it up
                            localStorage.setItem('countdownDays', eventData.countdownDays || 0);
                            localStorage.setItem('countdownHours', eventData.countdownHours || 0);
                            localStorage.setItem('countdownMinutes', eventData.countdownMinutes || 0);
                            localStorage.setItem('countdownSeconds', eventData.countdownSeconds || 0);
                            
                            console.log('Set countdown fields and localStorage:', {
                                days: eventData.countdownDays,
                                hours: eventData.countdownHours,
                                minutes: eventData.countdownMinutes,
                                seconds: eventData.countdownSeconds
                            });
                        }
                    }
                    
                    // Trigger any necessary updates
                    if (eventTitleInput) {
                        eventTitleInput.dispatchEvent(new Event('input'));
                    }
                    if (eventDateInput) {
                        eventDateInput.dispatchEvent(new Event('input'));
                    }
                    if (eventVenueInput) {
                        eventVenueInput.dispatchEvent(new Event('input'));
                    }
                    
                        // Clear the Ticketmaster data after loading (with delay to ensure it's processed)
                        // But only if we're not on ngrok (ngrok might need more time)
                        const isNgrok = window.location.hostname.includes('ngrok') || window.location.hostname.includes('ngrok.io');
                        const clearDelay = isNgrok ? 3000 : 1000; // Give ngrok more time
                        
                        setTimeout(() => {
                            localStorage.removeItem('ticketmasterEventData');
                            localStorage.setItem('ticketmasterDataCleared', 'true');
                            console.log('Ticketmaster data cleared from localStorage after', clearDelay, 'ms');
                        }, clearDelay);
                        
                        console.log('Ticketmaster event data loaded successfully');
                        
                        // Show success modal
                        showDataLoadedModal();
                    }, 100); // 100ms delay to ensure DOM is ready
                    } catch (parseError) {
                        console.error('Error parsing Ticketmaster data:', parseError);
                        console.log('Falling back to saved values');
                        loadSavedValues();
                    }
                } else {
                    console.log('No valid Ticketmaster data found, loading saved values');
                    console.log('Data was:', ticketmasterData);
                    loadSavedValues();
                }
            } catch (error) {
                console.error('Error in loadTicketmasterEventData:', error);
                console.log('Falling back to saved values');
                loadSavedValues();
            }
        }
        
        // Test function to manually trigger data loading (for debugging)
        function testTicketmasterDataLoad() {
            console.log('Testing Ticketmaster data load...');
            const testData = {
                title: 'Test Event',
                date: 'Sat, Dec 25, 8:00 PM',
                venue: 'Test Venue',
                ticketPrice: '50.00',
                bannerImage: 'https://via.placeholder.com/800x400/0066cc/ffffff?text=Test+Event'
            };
            
            localStorage.setItem('ticketmasterEventData', JSON.stringify(testData));
            loadTicketmasterEventData();
        }
        
        // Debug function for ngrok issues
        function debugNgrokData() {
            console.log('=== NGROK DEBUG INFO ===');
            console.log('Current URL:', window.location.href);
            console.log('Current domain:', window.location.hostname);
            console.log('localStorage available:', typeof(Storage) !== "undefined");
            console.log('localStorage length:', localStorage.length);
            
            // Check all localStorage keys
            console.log('All localStorage keys:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(`  ${key}: ${localStorage.getItem(key)}`);
            }
            
            // Check specifically for ticketmaster data
            const ticketmasterData = localStorage.getItem('ticketmasterEventData');
            console.log('Ticketmaster data exists:', !!ticketmasterData);
            console.log('Ticketmaster data value:', ticketmasterData);
            
            // Check if we're on ngrok
            const isNgrok = window.location.hostname.includes('ngrok') || window.location.hostname.includes('ngrok.io');
            console.log('Is ngrok URL:', isNgrok);
            
            // Check if data was cleared
            const wasCleared = localStorage.getItem('ticketmasterDataCleared');
            console.log('Data was cleared:', wasCleared);
            
            console.log('========================');
        }
        
        // Make debug function globally available
        window.debugNgrokData = debugNgrokData;
        window.testTicketmasterDataLoad = testTicketmasterDataLoad;
        
        function showDataLoadedModal() {
            const modal = document.getElementById('dataLoadedModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Auto-close after 3 seconds
            setTimeout(() => {
                closeDataLoadedModal();
            }, 3000);
        }
        
        function closeDataLoadedModal() {
            const modal = document.getElementById('dataLoadedModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            // Check for Ticketmaster event data from home.html
            const hasTicketmasterData = localStorage.getItem('ticketmasterEventData');
            const isNgrok = window.location.hostname.includes('ngrok') || window.location.hostname.includes('ngrok.io');
            
            console.log('Environment check:', {
                hasTicketmasterData: !!hasTicketmasterData,
                isNgrok: isNgrok,
                hostname: window.location.hostname
            });
            
            if (hasTicketmasterData) {
                // Load Ticketmaster data first
                loadTicketmasterEventData();
                
                // For ngrok, also try a retry mechanism
                if (isNgrok) {
                    console.log('Ngrok detected, setting up retry mechanism...');
                    setTimeout(() => {
                        const stillHasData = localStorage.getItem('ticketmasterEventData');
                        if (stillHasData) {
                            console.log('Retrying Ticketmaster data load for ngrok...');
                            loadTicketmasterEventData();
                        }
                    }, 2000);
                }
            } else {
                // Only load saved values if no Ticketmaster data
                loadSavedValues();
            }
            
            // Setup live preview updates for all fields
            setupLivePreviewUpdates();
            
            // Initialize seat details visibility
            initializeSeatDetailsVisibility();
            
            // Force update all previews
            updateAllPreviews();
            
            // Start live preview countdown
            startPreviewCountdown();
            
            // NEW: Initialize camping date functionality AFTER everything else is loaded
            setTimeout(() => {
                initializeCampingDateFunctionality();
                
                // CRITICAL FIX: Ensure camping dates are displayed if camping is selected
                const isCampingEvent = document.getElementById('isCampingEvent');
                if (isCampingEvent && isCampingEvent.value === 'true') {
                    console.log('Camping is selected on page load, updating display...');
                    setTimeout(() => {
                        updateCampingDatePreview();
                    }, 200);
                }
            }, 100);
            
            // Handle file input for banner image
            document.getElementById('bannerImage').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    // Check file size (max 2MB)
                    if (file.size > 2 * 1024 * 1024) {
                        alert('File size exceeds 2MB. Please choose a smaller image.');
                        this.value = ''; // Clear the file input
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageUrl = e.target.result;
                        console.log("Banner image loaded, data length:", imageUrl.length);
                        
                        // Update preview
                        document.getElementById('bannerPreview').style.backgroundImage = `url('${imageUrl}')`;
                        document.getElementById('previewBanner').style.backgroundImage = `url('${imageUrl}')`;
                        
                        // Save to localStorage
                        localStorage.setItem('bannerImage', imageUrl);
                        console.log("Banner image saved to localStorage");
                        
                        // Clear the default banner dropdown when a file is selected
                        document.getElementById('useDefaultBanner').value = '';
                        
                        // Force a storage event for other open tabs
                        try {
                            // This is a hack to trigger storage events in the same tab
                            const storageEvent = new StorageEvent('storage', {
                                key: 'bannerImage',
                                newValue: imageUrl,
                                url: window.location.href
                            });
                            window.dispatchEvent(storageEvent);
                        } catch (e) {
                            console.error("Could not dispatch storage event:", e);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Handle default banner selection
            document.getElementById('useDefaultBanner').addEventListener('change', function() {
                const imageUrl = this.value;
                if (imageUrl) {
                    console.log("Default banner selected:", imageUrl);
                    
                    // Update preview
                    document.getElementById('bannerPreview').style.backgroundImage = `url('${imageUrl}')`;
                    document.getElementById('previewBanner').style.backgroundImage = `url('${imageUrl}')`;
                    
                    // Save to localStorage
                    localStorage.setItem('bannerImage', imageUrl);
                    console.log("Default banner saved to localStorage");
                    
                    // Clear the file input when a default is selected
                    document.getElementById('bannerImage').value = '';
                }
            });
            
            // Handle countdown target date change
            const countdownTarget = document.getElementById('countdownTarget');
            if (countdownTarget) {
                countdownTarget.addEventListener('change', function() {
                    console.log('Countdown target date changed:', this.value);
                    
                    if (this.value) {
                        const targetDate = new Date(this.value);
                        const now = new Date();
                        const diff = targetDate - now;
                        
                        if (diff <= 0) {
                            alert('Please select a future date and time');
                            return;
                        }
                        
                        // Calculate time components
                        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        
                        // Update input fields
                        document.getElementById('countdownDays').value = days;
                        document.getElementById('countdownHours').value = hours;
                        document.getElementById('countdownMinutes').value = minutes;
                        document.getElementById('countdownSeconds').value = seconds;
                        
                        // Start countdown with new values
                        startPreviewCountdown();
                    }
                });
            }
            
            // Handle save button click
            const saveButton = document.getElementById('saveButton');
            if (saveButton) {
                console.log('Save button found, adding event listener');
                saveButton.addEventListener('click', function() {
                    console.log('Save button clicked');
                    saveChanges();
                });
            }
        });
        
        function setupLivePreviewUpdates() {
            console.log('Setting up live preview updates');
            
            // Event title live update
            const eventTitleInput = document.getElementById('eventTitle');
            const previewEventTitle = document.getElementById('previewEventTitle');
            
            if (eventTitleInput && previewEventTitle) {
                console.log('Setting up event title listener');
                eventTitleInput.addEventListener('input', function() {
                    console.log('Event title changed to:', this.value);
                    previewEventTitle.textContent = this.value || 'Ticket Name';
                });
            } else {
                console.error('Could not find event title elements', {
                    eventTitleInput: !!eventTitleInput,
                    previewEventTitle: !!previewEventTitle
                });
            }
            
            // Event date and venue live update
            const eventDateInput = document.getElementById('eventDate');
            const eventVenueInput = document.getElementById('eventVenue');
            const previewEventDetails = document.getElementById('previewEventDetails');
            
            if (eventDateInput && eventVenueInput && previewEventDetails) {
                console.log('Setting up event details listeners');
                
                const updateEventDetails = function() {
                    const date = eventDateInput.value || 'Sat, Nov 22, 7:00 PM';
                    const venue = eventVenueInput.value || 'Chase Center';
                    const detailsText = `${date} â€¢ ${venue}`;
                    
                    console.log('Setting event details preview to:', detailsText);
                    previewEventDetails.textContent = detailsText;
                };
                
                eventDateInput.addEventListener('input', function() {
                    console.log('Event date changed to:', this.value);
                    updateEventDetails();
                });
                
                eventVenueInput.addEventListener('input', function() {
                    console.log('Event venue changed to:', this.value);
                    updateEventDetails();
                });
            } else {
                console.error('Could not find event details elements', {
                    eventDateInput: !!eventDateInput,
                    eventVenueInput: !!eventVenueInput,
                    previewEventDetails: !!previewEventDetails
                });
            }
            
            // Ticket type live update
            const ticketTypeSelect = document.getElementById('ticketType');
            const previewTicketType = document.getElementById('previewTicketType');
            const customTicketTypeInput = document.getElementById('customTicketType');
            const customTicketTypeGroup = document.getElementById('customTicketTypeGroup');
            
            if (ticketTypeSelect && previewTicketType && customTicketTypeInput && customTicketTypeGroup) {
                console.log('Setting up ticket type listener with custom input support');
                
                function updatePreview() {
                    if (ticketTypeSelect.value === 'Custom') {
                        previewTicketType.textContent = customTicketTypeInput.value || 'Custom';
                        customTicketTypeGroup.style.display = 'block';
                    } else {
                        previewTicketType.textContent = ticketTypeSelect.value || 'General Sale';
                        customTicketTypeGroup.style.display = 'none';
                    }
                }
                
                ticketTypeSelect.addEventListener('change', function() {
                    updatePreview();
                });
                
                customTicketTypeInput.addEventListener('input', function() {
                    if (ticketTypeSelect.value === 'Custom') {
                        previewTicketType.textContent = this.value || 'Custom';
                    }
                });
                
                updatePreview();
            } else {
                console.error('Could not find ticket type elements or custom input elements', {
                    ticketTypeSelect: !!ticketTypeSelect,
                    previewTicketType: !!previewTicketType,
                    customTicketTypeInput: !!customTicketTypeInput,
                    customTicketTypeGroup: !!customTicketTypeGroup
                });
            }
            // Seat information live updates
            setupSeatInfoUpdates();
            
            // Countdown timer live updates
            setupCountdownUpdates();
        }
        
        function setupCountdownUpdates() {
            // Set up countdown timer live updates
            const countdownDays = document.getElementById('countdownDays');
            const countdownHours = document.getElementById('countdownHours');
            const countdownMinutes = document.getElementById('countdownMinutes');
            const countdownSeconds = document.getElementById('countdownSeconds');
            
            if (countdownDays) {
                countdownDays.addEventListener('input', updateCountdownPreview);
            }
            if (countdownHours) {
                countdownHours.addEventListener('input', updateCountdownPreview);
            }
            if (countdownMinutes) {
                countdownMinutes.addEventListener('input', updateCountdownPreview);
            }
            if (countdownSeconds) {
                countdownSeconds.addEventListener('input', updateCountdownPreview);
            }
        }
        
        function updateCountdownPreview() {
            // Update countdown preview when values change
            const days = document.getElementById('countdownDays')?.value || '0';
            const hours = document.getElementById('countdownHours')?.value || '0';
            const minutes = document.getElementById('countdownMinutes')?.value || '0';
            const seconds = document.getElementById('countdownSeconds')?.value || '0';
            
            const previewDays = document.getElementById('previewDays');
            const previewHours = document.getElementById('previewHours');
            const previewMinutes = document.getElementById('previewMinutes');
            const previewSeconds = document.getElementById('previewSeconds');
            
            if (previewDays) previewDays.textContent = days.padStart(2, '0');
            if (previewHours) previewHours.textContent = hours.padStart(2, '0');
            if (previewMinutes) previewMinutes.textContent = minutes.padStart(2, '0');
            if (previewSeconds) previewSeconds.textContent = seconds.padStart(2, '0');
        }
        
        function setupSeatInfoUpdates() {
            // Set up seat information live updates
            const seatTypeSelect = document.getElementById('seatType');
            const sectionInput = document.getElementById('section');
            const rowInput = document.getElementById('row');
            const seatInput = document.getElementById('seat');
            const ticketCountInput = document.getElementById('ticketCount');
            
            if (seatTypeSelect) {
                seatTypeSelect.addEventListener('change', updateSeatInfoPreview);
            }
            if (sectionInput) {
                sectionInput.addEventListener('input', updateSeatInfoPreview);
            }
            if (rowInput) {
                rowInput.addEventListener('input', updateSeatInfoPreview);
            }
            if (seatInput) {
                seatInput.addEventListener('input', updateSeatInfoPreview);
            }
            if (ticketCountInput) {
                ticketCountInput.addEventListener('input', updateSeatInfoPreview);
            }
        }
        
        function updateEventDetailsPreview() {
            console.log('Updating event details preview');
            
            const eventDateInput = document.getElementById('eventDate');
            const eventVenueInput = document.getElementById('eventVenue');
            const previewEventDetails = document.getElementById('previewEventDetails');
            
            if (eventDateInput && eventVenueInput && previewEventDetails) {
                const date = eventDateInput.value || 'Sat, Nov 22, 7:00 PM';
                const venue = eventVenueInput.value || 'Chase Center';
                const detailsText = `${date} â€¢ ${venue}`;
                
                console.log('Setting event details preview to:', detailsText);
                previewEventDetails.textContent = detailsText;
            } else {
                console.error('Could not update event details preview - missing elements', {
                    eventDateInput: !!eventDateInput,
                    eventVenueInput: !!eventVenueInput,
                    previewEventDetails: !!previewEventDetails
                });
            }
        }
        
        function loadSavedValues() {
            console.log('Loading saved values from localStorage');
            
            // Event details
            const eventTitle = localStorage.getItem('eventTitle') || 'Ticket Name';
            const eventDate = localStorage.getItem('eventDate') || 'Sat, Nov 22, 7:00 PM';
            const eventVenue = localStorage.getItem('eventVenue') || 'Chase Center';
            const ticketType = localStorage.getItem('ticketType') || 'American ExpressÂ® Presale';
            
            console.log('Loaded event details:', { eventTitle, eventDate, eventVenue, ticketType });
            
            // Set form values
            document.getElementById('eventTitle').value = eventTitle;
            document.getElementById('eventDate').value = eventDate;
            document.getElementById('eventVenue').value = eventVenue;
            document.getElementById('ticketType').value = ticketType;
            
            // Set preview values
            document.getElementById('previewEventTitle').textContent = eventTitle;
            document.getElementById('previewEventDetails').textContent = `${eventDate} â€¢ ${eventVenue}`;
            document.getElementById('previewTicketType').textContent = ticketType;
            
            // Seat information
            document.getElementById('section').value = localStorage.getItem('section') || '...';
            document.getElementById('seatType').value = localStorage.getItem('seatType') || 'General Admission';
            document.getElementById('row').value = localStorage.getItem('row') || '22';
            document.getElementById('seat').value = localStorage.getItem('seat') || '24';
            document.getElementById('ticketCount').value = localStorage.getItem('ticketCount') || '3';
            
            // Update seat info preview
            updateSeatInfoPreview();
            
            // Countdown timer
            document.getElementById('countdownDays').value = localStorage.getItem('countdownDays') || '179';
            document.getElementById('countdownHours').value = localStorage.getItem('countdownHours') || '08';
            document.getElementById('countdownMinutes').value = localStorage.getItem('countdownMinutes') || '36';
            document.getElementById('countdownSeconds').value = localStorage.getItem('countdownSeconds') || '11';
            
            // Countdown target date
            const savedTargetDate = localStorage.getItem('countdownTargetDate');
            if (savedTargetDate) {
                const targetDate = new Date(savedTargetDate);
                // Format for datetime-local input: YYYY-MM-DDThh:mm
                const formattedDate = targetDate.toISOString().slice(0, 16);
                document.getElementById('countdownTarget').value = formattedDate;
                
                // Also update the event date display with the correct year from countdown target
                const formattedEventDate = formatEventDate(targetDate);
                document.getElementById('eventDate').value = formattedEventDate;
                console.log('Updated event date with countdown target year:', formattedEventDate);
            }
            
            // Load individual countdown preference if editing an event
            const editingEventId = localStorage.getItem('editingEventId');
            if (editingEventId) {
                const events = JSON.parse(localStorage.getItem('events') || '[]');
                const editingEvent = events.find(event => String(event.id) === editingEventId);
                if (editingEvent && editingEvent.showCountdown !== undefined) {
                    // Load the individual event's countdown preference
                    const showCountdownToggle = document.getElementById('showCountdownToggle');
                    if (showCountdownToggle) {
                        showCountdownToggle.checked = editingEvent.showCountdown;
                    }
                }
            }
            
            // Map location
            document.getElementById('mapLocation').value = localStorage.getItem('mapLocation') || 'Chase Center, San Francisco CA';
            
            // Banner image
            const savedBannerImage = localStorage.getItem('bannerImage');
            if (savedBannerImage) {
                document.getElementById('bannerPreview').style.backgroundImage = `url('${savedBannerImage}')`;
                document.getElementById('previewBanner').style.backgroundImage = `url('${savedBannerImage}')`;
            }
            
            // Load add-ons
            document.getElementById('vipEarlyEntryOption').value = localStorage.getItem('vipEarlyEntry') === 'true' ? 'true' : 'false';
            document.getElementById('merchPackageOption').value = localStorage.getItem('merchPackage') === 'true' ? 'true' : 'false';
            document.getElementById('premiumParkingOption').value = localStorage.getItem('premiumParking') === 'true' ? 'true' : 'false';
            
            // NEW: Load camping date settings
            loadCampingDateSettings();
        }
        
        function startPreviewCountdown() {
            console.log('Starting preview countdown');
            
            // Clear any existing interval
            if (previewCountdownInterval) {
                clearInterval(previewCountdownInterval);
                console.log('Cleared existing preview interval');
            }
            
            // Get values from inputs
            const days = parseInt(document.getElementById('countdownDays').value) || 0;
            const hours = parseInt(document.getElementById('countdownHours').value) || 0;
            const minutes = parseInt(document.getElementById('countdownMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('countdownSeconds').value) || 0;
            
            console.log(`Initial preview values: ${days}d ${hours}h ${minutes}m ${seconds}s`);
            
            // Set initial display
            document.getElementById('previewDays').textContent = days.toString().padStart(2, '0');
            document.getElementById('previewHours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('previewMinutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('previewSeconds').textContent = seconds.toString().padStart(2, '0');
            
            // Calculate target date
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + days);
            targetDate.setHours(targetDate.getHours() + hours);
            targetDate.setMinutes(targetDate.getMinutes() + minutes);
            targetDate.setSeconds(targetDate.getSeconds() + seconds);
            
            console.log('Preview target date:', targetDate);
            
            // Save target date to localStorage
            localStorage.setItem('countdownTargetDate', targetDate.toISOString());
            
            // Start interval
            previewCountdownInterval = setInterval(function() {
                const now = new Date();
                const diff = targetDate - now;
                
                if (diff <= 0) {
                    // Countdown finished
                    document.getElementById('previewDays').textContent = '00';
                    document.getElementById('previewHours').textContent = '00';
                    document.getElementById('previewMinutes').textContent = '00';
                    document.getElementById('previewSeconds').textContent = '00';
                    clearInterval(previewCountdownInterval);
                    console.log('Preview countdown finished');
                    return;
                }
                
                // Calculate remaining time
                const remainingDays = Math.floor(diff / (1000 * 60 * 60 * 24));
                const remainingHours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const remainingMinutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const remainingSeconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                // Update display
                document.getElementById('previewDays').textContent = remainingDays.toString().padStart(2, '0');
                document.getElementById('previewHours').textContent = remainingHours.toString().padStart(2, '0');
                document.getElementById('previewMinutes').textContent = remainingMinutes.toString().padStart(2, '0');
                document.getElementById('previewSeconds').textContent = remainingSeconds.toString().padStart(2, '0');
            }, 1000);
            
            console.log('Preview countdown interval started');
        }
        
        function restartPreviewCountdown() {
            console.log('Restarting preview countdown');
            
            // Clear any existing interval
            if (previewCountdownInterval) {
                clearInterval(previewCountdownInterval);
            }
            
            // Start a new countdown
            startPreviewCountdown();
        }
        
        function saveChanges() {
            try {
                console.log('Saving changes...');
                
                // Get form values
                const eventTitle = document.getElementById('eventTitle').value;
                const eventDate = document.getElementById('eventDate').value;
                const eventVenue = document.getElementById('eventVenue').value;
                const ticketTypeSelect = document.getElementById('ticketType');
                const customTicketTypeInput = document.getElementById('customTicketType');
                const section = document.getElementById('section').value;
                const row = document.getElementById('row').value;
                const seat = document.getElementById('seat').value;
                const ticketCount = document.getElementById('ticketCount').value;
                const seatType = document.getElementById('seatType').value;
                const ticketPrice = document.getElementById('ticketPrice').value || '89.50';
                const entryLevel = document.getElementById('entryLevel').value || 'Mobile Entry';
                const serviceFee = parseFloat(document.getElementById('serviceFee').value || '15.75');
                const facilityCharge = parseFloat(document.getElementById('facilityCharge').value || '5.00');
                const processingFee = parseFloat(document.getElementById('processingFee').value || '5.50');
                const paymentDateInput = document.getElementById('paymentDate');
                
                // NEW: Get camping date values
                const isCampingEvent = document.getElementById('isCampingEvent').value === 'true';
                const campingStartDate = isCampingEvent ? document.getElementById('campingStartDate').value : '';
                const campingEndDate = isCampingEvent ? document.getElementById('campingEndDate').value : '';
                const campingDateFormat = isCampingEvent ? document.getElementById('campingDateFormat').value : '';
                const customDateFormat = isCampingEvent && campingDateFormat === 'custom' ? document.getElementById('customDateFormat').value : '';
                
                console.log('Camping event data:', { isCampingEvent, campingStartDate, campingEndDate, campingDateFormat, customDateFormat });
                
                // NEW: Validate camping dates if camping event is selected
                if (isCampingEvent) {
                    console.log('Validating camping dates...');
                    if (!campingStartDate || !campingEndDate) {
                        alert('Please select both start and end dates for camping events.');
                        return;
                    }
                    
                    const start = new Date(campingStartDate);
                    const end = new Date(campingEndDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (start > end) {
                        alert('Start date must be before end date for camping events.');
                        return;
                    }
                    
                    if (start < today) {
                        alert('Start date cannot be in the past for camping events.');
                        return;
                    }
                    
                    if (campingDateFormat === 'custom' && !customDateFormat.trim()) {
                        alert('Please enter a custom date format for camping events.');
                        return;
                    }
                    
                    console.log('Camping dates validated successfully');
                }
                
                // Determine ticket type to save
                let ticketTypeToSave = '';
                if (ticketTypeSelect.value === 'Custom') {
                    ticketTypeToSave = customTicketTypeInput.value.trim() || 'Custom';
                } else {
                    ticketTypeToSave = ticketTypeSelect.value;
                }
                
                // Save to localStorage as current event
                localStorage.setItem('eventTitle', eventTitle);
                localStorage.setItem('eventDate', eventDate);
                localStorage.setItem('eventVenue', eventVenue);
                localStorage.setItem('ticketType', ticketTypeToSave);
                localStorage.setItem('section', section);
                localStorage.setItem('row', row);
                localStorage.setItem('seat', seat);
                localStorage.setItem('ticketCount', ticketCount);
                localStorage.setItem('seatType', seatType);
                localStorage.setItem('ticketPrice', ticketPrice);
                localStorage.setItem('entryLevel', entryLevel);
                localStorage.setItem('serviceFee', serviceFee);
                localStorage.setItem('facilityCharge', facilityCharge);
                localStorage.setItem('processingFee', processingFee);
                
                if (paymentDateInput && paymentDateInput.value) {
                    const paymentDate = new Date(paymentDateInput.value);
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    localStorage.setItem('paymentDate', paymentDate.toLocaleDateString('en-US', options));
                }
                
        // Also save to events list
        const bannerImage = localStorage.getItem('bannerImage') || 'https://source.unsplash.com/random/800x600/?concert';

        // Check if editing existing event
        let eventId = localStorage.getItem('editingEventId');
        const isEditing = !!eventId;
        if (!eventId) {
            // New event, generate ID
            eventId = Date.now().toString();
        }
        eventId = String(eventId);

        // Ensure eventId is a string and consistent
        eventId = String(eventId);

        // Save venueImage and mapLocation per eventId in a single object to avoid overwriting
        const venueMapDataKey = 'venueMapData';
        let venueMapData = JSON.parse(localStorage.getItem(venueMapDataKey) || '{}');

        // Get current venueImage and mapLocation values
        const venueImage = localStorage.getItem('venueImage') || '';
        const mapLocation = document.getElementById('mapLocation').value || '';

        // If both venueImage and mapLocation are empty, remove the entry for this eventId to avoid stale data
        if (!venueImage && !mapLocation) {
            if (venueMapData.hasOwnProperty(eventId)) {
                delete venueMapData[eventId];
            }
        } else {
            // Update venueMapData for this eventId
            venueMapData[eventId] = {
                venueImage: venueImage,
                mapLocation: mapLocation
            };
        }

        // Save updated venueMapData back to localStorage
        localStorage.setItem(venueMapDataKey, JSON.stringify(venueMapData));

        // NEW: Save camping date format preferences globally
        if (isCampingEvent) {
            localStorage.setItem('preferredCampingDateFormat', campingDateFormat);
            if (customDateFormat) {
                localStorage.setItem('preferredCustomDateFormat', customDateFormat);
            }
        }
        
        // Save countdown target date and parts per event
        const countdownTargetDate = localStorage.getItem('countdownTargetDate') || '';
        const countdownDays = localStorage.getItem('countdownDays') || '0';
        const countdownHours = localStorage.getItem('countdownHours') || '0';
        const countdownMinutes = localStorage.getItem('countdownMinutes') || '0';
        const countdownSeconds = localStorage.getItem('countdownSeconds') || '0';
        
        // Get individual countdown preference for this event
        const showCountdownToggle = document.getElementById('showCountdownToggle');
        let individualShowCountdown = showCountdownToggle ? showCountdownToggle.checked : true;
        
        // 48-hour rule: If event is within 48 hours, don't show countdown
        if (countdownTargetDate) {
            const targetDate = new Date(countdownTargetDate);
            const now = new Date();
            const hoursUntilEvent = (targetDate - now) / (1000 * 60 * 60);
            
            if (hoursUntilEvent <= 48 && hoursUntilEvent > 0) {
                individualShowCountdown = false;
                console.log('Event is within 48 hours, countdown disabled. Hours until event:', hoursUntilEvent);
            }
        }

        // Debug logging for camping event data
        console.log('=== SAVING EVENT DATA DEBUG ===');
        console.log('Is camping event:', isCampingEvent);
        console.log('Camping start date:', campingStartDate);
        console.log('Camping end date:', campingEndDate);
        console.log('Parseable date from localStorage:', localStorage.getItem('campingParseableDate'));
        console.log('========================');
        
        // Compute finalParseableDate (YYYY-MM-DD) from available sources
        let finalParseableDate = null;

        try {
            if (isCampingEvent) {
                // campingParseableDate should have been saved earlier when formatting camping dates
                const campingParseable = localStorage.getItem('campingParseableDate');
                if (campingParseable) {
                    finalParseableDate = campingParseable;
                } else if (campingStartDate) {
                    // Fallback: use campingStartDate (ISO date) if available
                    const d = new Date(campingStartDate);
                    if (!isNaN(d)) {
                        finalParseableDate = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    }
                }
            }

            // If still no parseable date, derive from countdownTargetDate if present
            if (!finalParseableDate && countdownTargetDate) {
                const t = new Date(countdownTargetDate);
                if (!isNaN(t)) {
                    finalParseableDate = `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(2, '0')}-${String(t.getDate()).padStart(2, '0')}`;
                }
            }
        } catch (e) {
            console.error('Error computing finalParseableDate:', e);
            finalParseableDate = null;
        }

        const eventData = {
            id: eventId,
            title: eventTitle,
            date: eventDate,
            venue: eventVenue,
            ticketType: ticketTypeToSave,
            section: section,
            row: row,
            seat: seat,
            ticketCount: ticketCount,
            seatType: seatType,
            imageUrl: bannerImage,
            bannerImage: bannerImage, // Add banner image to event data
            venueImage: venueImage, // Add venue image to event data
            venueLocation: mapLocation, // Add venue location to event data
            ticketPrice: ticketPrice,
            entryLevel: entryLevel,
            countdownTargetDate: countdownTargetDate,
            countdownDays: countdownDays,
            countdownHours: countdownHours,
            countdownMinutes: countdownMinutes,
            countdownSeconds: countdownSeconds,
            showCountdown: individualShowCountdown, // Individual countdown preference per event
            // NEW: Add camping date data
            isCampingEvent: isCampingEvent,
            campingStartDate: campingStartDate,
            campingEndDate: campingEndDate,
            campingDateFormat: campingDateFormat,
            customDateFormat: customDateFormat,
            // CRITICAL FIX: Add parseable date for proper categorization in my-events
            parseableDate: finalParseableDate,
            createdAt: new Date().toISOString()
        };

        // Get existing events or initialize empty array
        const events = JSON.parse(localStorage.getItem('events') || '[]');

        // Find index of existing event if editing
        const existingIndex = events.findIndex(event => String(event.id) === eventId);

        if (isEditing) {
            if (existingIndex !== -1) {
                // Update existing event
                events[existingIndex] = eventData;
                localStorage.setItem('events', JSON.stringify(events));
                localStorage.removeItem('editingEventId');
            } else {
                // Editing but event not found, show error and do not add
                alert('Error: The event you are trying to edit no longer exists.');
                localStorage.removeItem('editingEventId');
                return;
            }
        } else {
            // Add new event
            events.push(eventData);
            localStorage.setItem('events', JSON.stringify(events));
        }

        // Clear editingEventId after save
        localStorage.removeItem('editingEventId');

        // Show the modal at the end of the function
        const modal = document.getElementById('saveModal');
        if (modal) {
            modal.style.display = 'block';
        }
            } catch (error) {
                console.error('Error saving changes:', error);
                alert('Error saving changes. Please try again.');
            }
        }

        // Function to update seat info preview
        function updateSeatInfoPreview() {
            const seatInfoContainer = document.getElementById('seatInfoContainer');
            if (!seatInfoContainer) return;
            
            const seatType = document.getElementById('seatType').value;
            const section = document.getElementById('section').value;
            const row = document.getElementById('row').value;
            const seat = document.getElementById('seat').value;
            
            // Clear previous content
            seatInfoContainer.innerHTML = '';
            
            if (seatType === 'General Admission') {
                // For General Admission, just show section
                seatInfoContainer.innerHTML = `
                    <div class="general-admission-layout">
                        <div class="seat-column">
                            <div class="seat-label">SECTION</div>
                            <div class="seat-value">${section || '...'}</div>
                        </div>
                        <div class="general-admission-text">GENERAL ADMISSION</div>
                    </div>
                `;
            } else {
                // For reserved seating, show section, row, and seat
                seatInfoContainer.innerHTML = `
                    <div class="seat-column">
                        <div class="seat-label">SECTION</div>
                        <div class="seat-value">${section || '...'}</div>
                    </div>
                    <div class="seat-column">
                        <div class="seat-label">ROW</div>
                        <div class="seat-value">${row || '22'}</div>
                    </div>
                    <div class="seat-column">
                        <div class="seat-label">SEAT</div>
                        <div class="seat-value">${seat || '24'}</div>
                    </div>
                `;
            }
        }

        // Make sure the functions are available globally
        window.saveChanges = saveChanges;
        window.updateSeatInfoPreview = updateSeatInfoPreview;

        // Function to close the modal
        function closeModal() {
            const modal = document.getElementById('saveModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Make closeModal available globally
        window.closeModal = closeModal;

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('saveModal');
            if (modal && event.target === modal) {
                modal.style.display = 'none';
            }
        };

        // Format date for event display
        function formatEventDate(date) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const dayName = days[date.getDay()];
            const monthName = months[date.getMonth()];
            const dayNum = date.getDate();
            const year = date.getFullYear();
            
            // Format time (12-hour with AM/PM)
            let hours = date.getHours();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${dayName}, ${monthName} ${dayNum}, ${year}, ${hours}:${minutes} ${ampm}`;
        }

        // Event date input should update countdown target
        document.getElementById('eventDate').addEventListener('change', function() {
            const eventDateStr = this.value;
            if (eventDateStr) {
                try {
                    // Try to parse the event date string
                    const eventDate = parseEventDate(eventDateStr);
                    if (eventDate) {
                        // Format for datetime-local input: YYYY-MM-DDThh:mm
                        const formattedDate = eventDate.toISOString().slice(0, 16);
                        document.getElementById('countdownTarget').value = formattedDate;
                        
                        // Trigger the countdown target change event
                        const event = new Event('change');
                        document.getElementById('countdownTarget').dispatchEvent(event);
                    }
                } catch (e) {
                    console.error("Could not parse event date:", e);
                }
            }
        });

        // Parse event date string (e.g., "Sat, Nov 22, 7:00 PM")
        function parseEventDate(dateStr) {
            try {
                const regex = /([A-Za-z]+),\s+([A-Za-z]+)\s+(\d+),\s+(\d+):(\d+)\s+([AP]M)/;
                const match = dateStr.match(regex);
                
                if (match) {
                    const [_, dayName, monthName, day, hours, minutes, ampm] = match;
                    
                    const months = {
                        'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                        'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                    };
                    
                    let hour = parseInt(hours);
                    if (ampm === 'PM' && hour < 12) hour += 12;
                    if (ampm === 'AM' && hour === 12) hour = 0;
                    
                    const date = new Date();
                    date.setMonth(months[monthName]);
                    date.setDate(parseInt(day));
                    date.setHours(hour);
                    date.setMinutes(parseInt(minutes));
                    date.setSeconds(0);
                    
                    return date;
                }
            } catch (e) {
                console.error("Error parsing date:", e);
            }
            
            return null;
        }

        // Show/hide row and seat inputs based on seat type
        document.getElementById('seatType').addEventListener('change', function() {
            const seatDetailsGroups = document.querySelectorAll('.seat-details');
            if (this.value === 'General Admission') {
                seatDetailsGroups.forEach(group => group.style.display = 'none');
            } else {
                seatDetailsGroups.forEach(group => group.style.display = 'block');
            }
            
            // Update the preview immediately when seat type changes
            updateSeatInfoPreview();
        });

        // Initialize seat details visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            const seatType = document.getElementById('seatType').value;
            const seatDetailsGroups = document.querySelectorAll('.seat-details');
            if (seatType === 'General Admission') {
                seatDetailsGroups.forEach(group => group.style.display = 'none');
            } else {
                seatDetailsGroups.forEach(group => group.style.display = 'block');
            }
        });

        // Handle countdown target date input
        document.getElementById('countdownTarget').addEventListener('change', function() {
            console.log('Countdown target date changed:', this.value);
            
            if (this.value) {
                try {
                    const targetDate = new Date(this.value);
                    const now = new Date();
                    const diff = targetDate - now;
                    
                    if (diff <= 0) {
                        alert('Please select a future date and time');
                        return;
                    }
                    
                    // Calculate time components
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    console.log(`Calculated time difference: ${days}d ${hours}h ${minutes}m ${seconds}s`);
                    
                    // Update input fields
                    document.getElementById('countdownDays').value = days;
                    document.getElementById('countdownHours').value = hours;
                    document.getElementById('countdownMinutes').value = minutes;
                    document.getElementById('countdownSeconds').value = seconds;
                    
                    // Update preview display
                    document.getElementById('previewDays').textContent = String(days).padStart(2, '0');
                    document.getElementById('previewHours').textContent = String(hours).padStart(2, '0');
                    document.getElementById('previewMinutes').textContent = String(minutes).padStart(2, '0');
                    document.getElementById('previewSeconds').textContent = String(seconds).padStart(2, '0');
                    
                    // Update event date and time
                    const formattedDate = formatEventDate(targetDate);
                    document.getElementById('eventDate').value = formattedDate;
                    
                    // Update event details preview
                    updateEventDetailsPreview();
                    
                    // Restart countdown
                    restartPreviewCountdown();
                } catch (error) {
                    console.error('Error processing target date:', error);
                    alert('Invalid date format. Please try again.');
                }
            }
        });

        // Handle venue image upload
        document.getElementById('venueImage').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                
                // Check file size (limit to 1MB for Vercel compatibility)
                if (file.size > 1 * 1024 * 1024) {
                    alert('Image is too large. Please select an image under 1MB for better compatibility.');
                    this.value = '';
                    return;
                }
                
                // Create a canvas to compress the image
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions (max 600x400 for Vercel compatibility)
                    let { width, height } = img;
                    const maxWidth = 600;
                    const maxHeight = 400;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    // Set canvas dimensions
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress image with higher compression for Vercel
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to compressed data URL (0.6 quality for Vercel compatibility)
                    const compressedImageUrl = canvas.toDataURL('image/jpeg', 0.6);
                    
                    console.log('Original file size:', file.size, 'bytes');
                    console.log('Compressed image size:', compressedImageUrl.length, 'characters');
                    
                    // Stricter validation for Vercel (300KB limit)
                    if (compressedImageUrl.length > 300000) {
                        alert('Image is still too large after compression. Please try a smaller image.');
                        return;
                    }
                    
                    // Update preview
                    const previewElement = document.getElementById('venueImagePreview');
                    if (previewElement) {
                        previewElement.style.backgroundImage = `url('${compressedImageUrl}')`;
                    }
                    
                    // Save to localStorage with Vercel-specific validation
                    try {
                        // Test if localStorage can handle this data
                        const testKey = 'venueImageTest';
                        localStorage.setItem(testKey, compressedImageUrl);
                        const testRetrieval = localStorage.getItem(testKey);
                        
                        if (testRetrieval && testRetrieval.length > 100) {
                            // Clear test data
                            localStorage.removeItem(testKey);
                            
                            // Save actual venue image
                            localStorage.setItem('venueImage', compressedImageUrl);
                            console.log("Compressed venue image saved to localStorage for Vercel");
                            
                            // Additional validation for Vercel
                            const finalCheck = localStorage.getItem('venueImage');
                            if (finalCheck && finalCheck.length > 100) {
                                console.log("Venue image saved and retrieved successfully for Vercel deployment");
                            } else {
                                console.error("Venue image not saved properly for Vercel");
                                alert('Failed to save image for deployment. Please try a smaller image.');
                            }
                        } else {
                            console.error("localStorage test failed for Vercel");
                            alert('Storage test failed. Please try a smaller image.');
                        }
                    } catch (error) {
                        console.error('Error saving venue image for Vercel:', error);
                        alert('Failed to save image for deployment. Please try a smaller image or use a default image.');
                    }
                };
                
                img.onerror = function() {
                    console.error('Failed to load image for compression');
                    alert('Failed to process image. Please try a different image.');
                };
                
                // Load the image
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.onerror = function() {
                    console.error('Failed to read image file');
                    alert('Failed to read image file. Please try again.');
                };
                reader.readAsDataURL(file);
            }
        });

        // Save settings to localStorage
        const saveSettingsBtn = document.getElementById('saveSettings');
        if (saveSettingsBtn) {
            saveSettingsBtn.addEventListener('click', function() {
            // Existing code...
            
            // Save venue information
            const eventVenue = document.getElementById('eventVenue').value;
            const venueLocation = document.getElementById('venueLocation').value;
            
            localStorage.setItem('eventVenue', eventVenue);
            localStorage.setItem('venueLocation', venueLocation);
            
            // Show success message
            alert('Settings saved successfully!');
            });
        }

        // Load settings from localStorage
        function loadSettings() {
            // Existing code...

            // Check if editing existing event
            let eventId = localStorage.getItem('editingEventId');
            if (!eventId) {
                // No editing event, load global venue info
                document.getElementById('eventVenue').value = localStorage.getItem('eventVenue') || 'Chase Center';

                // Load global venue image if available
                const venueMapDataKey = 'venueMapData';
                const venueMapData = JSON.parse(localStorage.getItem(venueMapDataKey) || '{}');
                const globalVenueImage = venueMapData['global'] ? venueMapData['global'].venueImage : null;
                const globalMapLocation = venueMapData['global'] ? venueMapData['global'].mapLocation : null;

                document.getElementById('venueLocation').value = globalMapLocation || 'San Francisco, CA';

                if (globalVenueImage) {
                    document.getElementById('venueImagePreview').style.backgroundImage = `url('${globalVenueImage}')`;
                }
                return;
            }

        // Load venue info per eventId
        eventId = String(eventId);
        const venueMapDataKey = 'venueMapData';
        const venueMapData = JSON.parse(localStorage.getItem(venueMapDataKey) || '{}');

        document.getElementById('eventVenue').value = localStorage.getItem('eventVenue') || 'Chase Center';

        // Check if venueMapData for eventId exists and has mapLocation and venueImage set
        if (venueMapData[eventId] && (venueMapData[eventId].mapLocation || venueMapData[eventId].venueImage)) {
            document.getElementById('venueLocation').value = venueMapData[eventId].mapLocation || 'San Francisco, CA';

            const venueImage = venueMapData[eventId].venueImage;
            if (venueImage) {
                document.getElementById('venueImagePreview').style.backgroundImage = `url('${venueImage}')`;
            }
        } else {
            // If no mapLocation or venueImage for this event, set default or empty values
            document.getElementById('venueLocation').value = 'San Francisco, CA';
            document.getElementById('venueImagePreview').style.backgroundImage = '';
        }
        }
    </script>

    <div id="saveModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">Changes Saved!</div>
        <div class="modal-message">Your ticket settings have been updated successfully.</div>
        <button class="modal-button" onclick="closeModal()">OK</button>
    </div>
</div>

    <!-- Add this right before the closing </body> tag -->
<script src="banner-handler.js"></script>

<script>
    // Function to update add-on count in localStorage
    function updateAddonCount() {
        let addonCount = 0;
        if (document.getElementById('vipEarlyEntryOption').value === 'true') addonCount++;
        if (document.getElementById('merchPackageOption').value === 'true') addonCount++;
        if (document.getElementById('premiumParkingOption').value === 'true') addonCount++;
        
        localStorage.setItem('addonCount', addonCount.toString());
        console.log('Updated addon count:', addonCount);
    }
    
    // Add this to saveChanges function
    const originalSaveChanges = window.saveChanges || function(){};
    window.saveChanges = function() {
        // Call the original function
        if (typeof originalSaveChanges === 'function') {
            originalSaveChanges();
        }
        
        // Update add-on count
        updateAddonCount();
    };
    
    // Update add-on count when options change
    document.addEventListener('DOMContentLoaded', function() {
        const vipOption = document.getElementById('vipEarlyEntryOption');
        const merchOption = document.getElementById('merchPackageOption');
        const parkingOption = document.getElementById('premiumParkingOption');
        
        if (vipOption) vipOption.addEventListener('change', updateAddonCount);
        if (merchOption) merchOption.addEventListener('change', updateAddonCount);
        if (parkingOption) parkingOption.addEventListener('change', updateAddonCount);
        
        // Initial update
        updateAddonCount();
    });
    
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('SW registered for scope:', reg.scope))
          .catch(err => console.log('SW registration failed:', err));
      });
    }
</script>

<script>
// Nuclear option: Smarter standalone enforcement
if (window.matchMedia('(display-mode: browser)').matches && !sessionStorage.getItem('pwaRedirected')) {
  sessionStorage.setItem('pwaRedirected', 'true');
  const intentUrl = `intent://${window.location.host}#Intent;package=com.android.chrome;scheme=https;end`;
  
  // Timeout prevents immediate reload loops
  setTimeout(() => {
    window.location.href = intentUrl;
  }, 500);
}
</script>

<script>
// PROPER Android PWA Touch Handlers
(function() {
  // 1. Save original touch coordinates
  let startY = 0;
  
  // 2. Improved touchmove handler
  document.addEventListener('touchstart', (e) => {
    startY = e.touches[0].clientY;
  }, { passive: true });

  document.addEventListener('touchmove', (e) => {
    // Only prevent pinch-zoom, allow scrolling
    if (e.scale !== 1 && e.touches.length > 1) {
      e.preventDefault();
    }
    
    // Allow vertical scrolling
    const y = e.touches[0].clientY;
    const isVerticalScroll = Math.abs(y - startY) > Math.abs(e.touches[0].clientX - startY);
    if (isVerticalScroll) {
      return; // Allow the scroll
    }
  }, { passive: false });

  // 3. Safe double-tap prevention
  let lastTap = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTap < 300) {
      e.preventDefault();
    }
    lastTap = now;
  }, { passive: false });
  
  // 4. Critical for Android PWA
  document.documentElement.style.touchAction = 'pan-y';
})();
</script>
<!-- Add this at the very end of your body tag, just before the closing </body> -->
<script>
// DIRECT FIX FOR ADD-ON OPTIONS
document.addEventListener('DOMContentLoaded', function() {
    console.log("DIRECT FIX: Setting up add-on option handlers");
    
    // Get the option elements
    const vipOption = document.getElementById('vipEarlyEntryOption');
    const merchOption = document.getElementById('merchPackageOption');
    const parkingOption = document.getElementById('premiumParkingOption');
    
    if (vipOption && merchOption && parkingOption) {
        console.log("DIRECT FIX: Found all option elements");
        
        // Function to update localStorage when an option changes
        function handleOptionChange(optionElement, storageKey) {
            console.log(`DIRECT FIX: Setting up handler for ${storageKey}`);
            
            // Set initial value in localStorage
            localStorage.setItem(storageKey, optionElement.value);
            console.log(`DIRECT FIX: Initial ${storageKey} value:`, optionElement.value);
            
            // Add change event listener
            optionElement.addEventListener('change', function() {
                console.log(`DIRECT FIX: ${storageKey} changed to:`, this.value);
                localStorage.setItem(storageKey, this.value);
                
                // Update add-on count
                updateAddonCount();
            });
        }
        
        // Set up handlers for each option
        handleOptionChange(vipOption, 'vipEarlyEntry');
        handleOptionChange(merchOption, 'merchPackage');
        handleOptionChange(parkingOption, 'premiumParking');
        
        // Function to update add-on count
        function updateAddonCount() {
            let count = 0;
            if (localStorage.getItem('vipEarlyEntry') === 'true') count++;
            if (localStorage.getItem('merchPackage') === 'true') count++;
            if (localStorage.getItem('premiumParking') === 'true') count++;
            
            console.log("DIRECT FIX: Calculated add-on count:", count);
            localStorage.setItem('addonCount', count.toString());
        }
        
        // Update add-on count initially
        updateAddonCount();
        
        // Override the save button click handler
        const saveButton = document.getElementById('saveSettings');
        if (saveButton) {
            console.log("DIRECT FIX: Found save button, adding click handler");
            
            saveButton.addEventListener('click', function() {
                console.log("DIRECT FIX: Save button clicked");
                
                // Update localStorage with current values
                localStorage.setItem('vipEarlyEntry', vipOption.value);
                localStorage.setItem('merchPackage', merchOption.value);
                localStorage.setItem('premiumParking', parkingOption.value);
                
                // Update add-on count
                updateAddonCount();
                
                console.log("DIRECT FIX: Add-on values saved:", {
                    vipEarlyEntry: vipOption.value,
                    merchPackage: merchOption.value,
                    premiumParking: parkingOption.value,
                    addonCount: localStorage.getItem('addonCount')
                });
            });
        }
    } else {
        console.error("DIRECT FIX: Could not find all option elements");
    }
});
</script>


<script>
// Add this function at the end of your existing script
function saveSettings() {
    // Existing code to save settings...
    
    // After saving all settings, calculate and store addon count
    let addonCount = 0;
    if (localStorage.getItem('vipEarlyEntry') === 'true') addonCount++;
    if (localStorage.getItem('merchPackage') === 'true') addonCount++;
    if (localStorage.getItem('premiumParking') === 'true') addonCount++;
    
    // Save addon count to localStorage
    localStorage.setItem('addonCount', addonCount.toString());
    
    // Show success message
    alert('Settings saved successfully!');
}
</script>


<script>
// Reliable add-on count calculator and synchronizer
(function() {
    // Define the function to calculate and update add-on count
    function updateAndSyncAddonCount() {
        // Get current values from localStorage (using string comparison)
        const vipEnabled = localStorage.getItem('vipEarlyEntry') === 'true';
        const merchEnabled = localStorage.getItem('merchPackage') === 'true';
        const parkingEnabled = localStorage.getItem('premiumParking') === 'true';
        
        // Calculate the count
        let count = 0;
        if (vipEnabled) count++;
        if (merchEnabled) count++;
        if (parkingEnabled) count++;
        
        // Update localStorage
        localStorage.setItem('addonCount', count.toString());
        console.log("Add-on count synchronized:", count);
        
        return count;
    }
    
    // Run on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Setting up reliable add-on count synchronization");
        
        // Get the option elements
        const vipOption = document.getElementById('vipEarlyEntryOption');
        const merchOption = document.getElementById('merchPackageOption');
        const parkingOption = document.getElementById('premiumParkingOption');
        
        // Add change listeners to each option
        if (vipOption) {
            vipOption.addEventListener('change', function() {
                localStorage.setItem('vipEarlyEntry', this.value);
                updateAndSyncAddonCount();
            });
        }
        
        if (merchOption) {
            merchOption.addEventListener('change', function() {
                localStorage.setItem('merchPackage', this.value);
                updateAndSyncAddonCount();
            });
        }
        
        if (parkingOption) {
            parkingOption.addEventListener('change', function() {
                localStorage.setItem('premiumParking', this.value);
                updateAndSyncAddonCount();
            });
        }
        
        // Override the saveSettings function to ensure count is updated
        const originalSaveSettings = window.saveSettings || function(){};
        window.saveSettings = function() {
            // Call original function if it exists
            if (typeof originalSaveSettings === 'function') {
                originalSaveSettings();
            }
            
            // Ensure add-on values are saved
            if (vipOption) localStorage.setItem('vipEarlyEntry', vipOption.value);
            if (merchOption) localStorage.setItem('merchPackage', merchOption.value);
            if (parkingOption) localStorage.setItem('premiumParking', parkingOption.value);
            
            // Update the count
            updateAndSyncAddonCount();
        };
        
        // Initial calculation
        updateAndSyncAddonCount();
    });
    
    // Also run before page unload to ensure latest count is saved
    window.addEventListener('beforeunload', updateAndSyncAddonCount);
})();
</script>

    <script>
        // --- Versioning and Reset Logic ---
        const DATA_VERSION = 2;
        if (localStorage.getItem('dataVersion') != DATA_VERSION) {
            localStorage.clear();
            localStorage.setItem('dataVersion', DATA_VERSION);
        }
        document.addEventListener('DOMContentLoaded', function() {
            const resetBtn = document.getElementById('resetAppBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', async function() {
                    if (confirm('This will clear all app data and reload. Continue?')) {
                        localStorage.clear();
                        // Unregister all service workers
                        if ('serviceWorker' in navigator) {
                            const regs = await navigator.serviceWorker.getRegistrations();
                            for (const reg of regs) { await reg.unregister(); }
                        }
                        location.reload();
                    }
                });
            }
        });
        // --- End Versioning and Reset Logic ---
    </script>
    
    <!-- Data Loaded Modal -->
    <div id="dataLoadedModal" class="modal-overlay">
        <div class="modal-content success-modal">
            <div class="success-icon">âœ…</div>
            <h3>Event Data Loaded!</h3>
            <p>Your event details have been pre-filled from Ticketmaster.</p>
            <button class="btn btn-primary" onclick="closeDataLoadedModal()">Continue</button>
        </div>
    </div>

</body></html>